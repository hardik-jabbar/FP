<!DOCTYPE html>
<html lang="en" class="bg-dark text-light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPS Tracking - FarmPower</title>
  <meta name="description" content="Track your farming equipment in real-time with FarmPower's GPS tracking solution">
  
  <!-- Mapbox GL JS -->
  <script src='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css' rel='stylesheet' />
  
  <!-- Mapbox GL Draw -->
  <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js'></script>
  <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css' type='text/css' />
  
  <!-- Turf.js for geospatial calculations -->
  <script src='https://unpkg.com/@turf/turf/turf.min.js'></script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            background: '#ffffff',
            foreground: '#000000',
            primary: {
              DEFAULT: '#2563eb',
              foreground: '#ffffff',
            },
            secondary: {
              DEFAULT: '#f3f4f6',
            },
            border: '#e5e7eb',
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
        },
      },
    }
  </script>
  <!-- External Scripts -->
  <script src="scripts/api.js"></script>
  <script src="scripts/cart.js"></script>
  <script src="scripts/main.js"></script>

  <style type="text/css">
    /* Base styles */
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Utility classes */
    .btn-icon {
      @apply p-2 hover:bg-secondary rounded-lg transition-colors;
    }

    .nav-link {
      @apply text-foreground/80 hover:text-foreground transition-colors;
    }

    /* Animations */
    .animate-fade-in {
      animation: fadeIn 0.4s ease-out;
    }

    .animate-scale-in {
      animation: scaleIn 0.3s ease-out;
    }

    .animate-slide-in {
      animation: slideIn 0.4s ease-out;
    }

    .animate-slide-up {
      animation: slideUp 0.4s ease-out;
    }

    @keyframes fadeIn {
      0% { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    @keyframes scaleIn {
      0% { transform: scale(0.95); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    @keyframes slideIn {
      0% { transform: translateX(-20px); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideUp {
      0% { transform: translateY(20px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #D1D5DB;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #9CA3AF;
    }

    #map {
        height: 600px;
        width: 100%;
        border-radius: 0.5rem;
        position: relative;
    }
    
    .map-overlay {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1;
        background: white;
        padding: 10px;
        border-radius: 4px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }
    
    .map-controls {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1;
    }
    
    .map-controls button {
        display: block;
        margin-bottom: 5px;
        padding: 8px 12px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .map-controls button:hover {
        background: #f5f5f5;
    }
    
    .field-stats {
        background: white;
        border-radius: 4px;
        padding: 15px;
        margin-top: 10px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    
    .equipment-marker {
        background-image: url('assets/images/tractor-icon.png');
        background-size: cover;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
    }
  </style>
  
  <!-- Common CSS -->
  <link rel="stylesheet" href="assets/css/marketplace.css">
  
  <!-- Common Scripts -->
  <script src="scripts/api.js" defer></script>
  <script src="scripts/cart.js" defer></script>
  <script src="scripts/common.js" defer></script>
</head>
<body class="min-h-screen flex flex-col bg-background text-foreground">
<!-- Navigation Header -->
<header class="border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 sticky top-0 z-50">
  <div class="container mx-auto px-4 md:px-6">
    <nav class="flex items-center justify-between py-4">
      <!-- Logo -->
      <a href="index.html" class="flex items-center space-x-2">
        <img src="assets/images/logo.png" alt="FarmPower Logo" class="h-8 w-auto">
        <span class="text-xl font-bold">FarmPower</span>
      </a>

      <!-- Main Navigation -->
      <ul class="hidden md:flex items-center space-x-8">
        <li>
          <a href="marketplace.html" class="text-foreground/80 hover:text-foreground transition-colors">
            Equipment Market
          </a>
        </li>
        <li>
          <a href="parts-marketplace.html" class="text-foreground/80 hover:text-foreground transition-colors">
            Parts Market
          </a>
        </li>
        <li>
          <a href="service-scheduling.html" class="text-foreground/80 hover:text-foreground transition-colors">
            Service
          </a>
        </li>
        <li>
          <a href="gps-tracking.html" class="text-foreground/80 hover:text-foreground transition-colors">
            GPS Tracking
          </a>
        </li>
        <li>
          <a href="crop-calculator.html" class="text-foreground/80 hover:text-foreground transition-colors">
            Crop Calculator
          </a>
        </li>
      </ul>

      <!-- User Menu -->
      <div class="flex items-center space-x-4">
        <a href="notifications.html" class="relative p-2 hover:bg-secondary rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
          </svg>
          <span id="notificationCount" class="absolute top-0 right-0 h-5 w-5 bg-primary text-primary-foreground rounded-full text-xs flex items-center justify-center">0</span>
        </a>

        <!-- User Dropdown (when logged in) -->
        <div id="userMenu" class="relative hidden">
          <button onclick="toggleUserMenu()" class="flex items-center space-x-2 hover:bg-secondary rounded-lg p-2">
            <img id="userAvatar" src="assets/images/avatar-placeholder.png" alt="User Avatar" class="h-8 w-8 rounded-full">
            <span id="userName" class="text-sm font-medium">User Name</span>
          </button>
          <div id="userDropdown" class="hidden absolute right-0 mt-2 w-48 bg-background border border-border rounded-lg shadow-lg py-1">
            <a href="profile.html" class="block px-4 py-2 text-sm hover:bg-secondary">Profile</a>
            <a href="my-equipment.html" class="block px-4 py-2 text-sm hover:bg-secondary">My Equipment</a>
            <a href="my-services.html" class="block px-4 py-2 text-sm hover:bg-secondary">My Services</a>
            <a href="settings.html" class="block px-4 py-2 text-sm hover:bg-secondary">Settings</a>
            <hr class="my-1 border-border">
            <button onclick="logout()" class="block w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-secondary">
              Logout
            </button>
          </div>
        </div>

        <!-- Auth Buttons (when logged out) -->
        <div id="authButtons" class="flex items-center space-x-4">
          <a href="login.html" class="text-sm font-medium hover:text-primary">Login</a>
          <a href="register.html" class="inline-flex items-center justify-center rounded-lg bg-primary px-4 py-2 text-sm font-medium text-primary-foreground shadow transition-colors hover:bg-primary/90">
            Register
          </a>
        </div>

        <!-- Mobile Menu Button -->
        <button onclick="toggleMobileMenu()" class="md:hidden p-2 hover:bg-secondary rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </nav>
  </div>

  <!-- Mobile Menu -->
  <div id="mobileMenu" class="md:hidden fixed inset-y-0 right-0 w-full max-w-sm bg-background border-l border-border transform translate-x-full transition-transform duration-200 ease-in-out">
    <div class="flex flex-col h-full">
      <div class="flex items-center justify-between p-4 border-b border-border">
        <span class="text-lg font-bold">Menu</span>
        <button onclick="toggleMobileMenu()" class="p-2 hover:bg-secondary rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <nav class="flex-1 overflow-y-auto p-4">
        <ul class="space-y-4">
          <li>
            <a href="marketplace.html" class="block text-lg hover:text-primary">Equipment Market</a>
          </li>
          <li>
            <a href="parts-marketplace.html" class="block text-lg hover:text-primary">Parts Market</a>
          </li>
          <li>
            <a href="service-scheduling.html" class="block text-lg hover:text-primary">Service</a>
          </li>
          <li>
            <a href="gps-tracking.html" class="block text-lg hover:text-primary">GPS Tracking</a>
          </li>
          <li>
            <a href="crop-calculator.html" class="block text-lg hover:text-primary">Crop Calculator</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

<script>
  // Toggle mobile menu
  function toggleMobileMenu() {
    const mobileMenu = document.getElementById('mobileMenu');
    mobileMenu.classList.toggle('translate-x-full');
  }

  // Toggle user dropdown
  function toggleUserMenu() {
    const dropdown = document.getElementById('userDropdown');
    dropdown.classList.toggle('hidden');
  }

  // Close dropdowns when clicking outside
  document.addEventListener('click', (e) => {
    const userMenu = document.getElementById('userMenu');
    const userDropdown = document.getElementById('userDropdown');
    
    if (!userMenu.contains(e.target)) {
      userDropdown.classList.add('hidden');
    }
  });

  // Handle authentication state
  function updateAuthState(isLoggedIn, userData = null) {
    const userMenu = document.getElementById('userMenu');
    const authButtons = document.getElementById('authButtons');
    
    if (isLoggedIn && userData) {
      userMenu.classList.remove('hidden');
      authButtons.classList.add('hidden');
      
      // Update user info
      document.getElementById('userName').textContent = userData.name;
      if (userData.avatar) {
        document.getElementById('userAvatar').src = userData.avatar;
      }
    } else {
      userMenu.classList.add('hidden');
      authButtons.classList.remove('hidden');
    }
  }

  // Check authentication state on page load
  async function checkAuth() {
    try {
      const response = await fetch('/api/user/me');
      if (response.ok) {
        const userData = await response.json();
        updateAuthState(true, userData);
      } else {
        updateAuthState(false);
      }
    } catch (error) {
      console.error('Error checking auth:', error);
      updateAuthState(false);
    }
  }

  // Logout function
  async function logout() {
    try {
      await fetch('/api/logout', { method: 'POST' });
      updateAuthState(false);
      window.location.href = "login.html";
    } catch (error) {
      console.error('Error logging out:', error);
    }
  }

  // Initialize
  checkAuth();
</script> 
<!-- Header -->
<div id="header"></div>

  <!-- Main Content -->
  <main class="container mx-auto px-4 md:px-6 py-12">
    
    <!-- GPS Tracking Header -->
    <div class="flex justify-between items-center mb-8">
      <div>
        <h1 class="text-3xl font-bold">GPS Tracking & Field Planning</h1>
        <p class="text-muted-foreground mt-2">Monitor equipment location and plan field operations</p>
      </div>
      
      <button id="addFieldBtn" onclick="showFieldForm()" class="inline-flex items-center justify-center rounded-lg bg-primary px-6 py-3 text-primary-foreground shadow hover:bg-opacity-90">
        Add New Field
        <svg xmlns="http://www.w3.org/2000/svg" class="ml-2 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>

    <!-- Map and Controls -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- Map -->
      <div class="lg:col-span-3">
        <!-- Google Maps Embed. Replace YOUR_API_KEY with a valid Google Maps Embed API key -->
<div class="relative">
  <div id="map" class="bg-gray-300 rounded-lg"></div>
  <div class="map-overlay">
    <div id="field-stats" class="field-stats hidden">
      <h4 class="font-semibold mb-2">Field Statistics</h4>
      <div id="stats-content"></div>
    </div>
  </div>
  <div class="map-controls">
    <button id="draw-polygon" class="mb-2" title="Draw Field">
      <i class="fas fa-draw-polygon"></i> Draw Field
    </button>
    <button id="delete-features" class="mb-2" title="Delete Selected">
      <i class="fas fa-trash"></i> Delete
    </button>
    <button id="calculate-area" class="mb-2" title="Calculate Area">
      <i class="fas fa-ruler-combined"></i> Calculate
    </button>
  </div>
</div>
      </div>

      <!-- Equipment List and Controls -->
      <div class="space-y-6">
        <!-- Equipment List -->
        <div class="bg-secondary/10 rounded-lg p-4">
          <h3 class="text-lg font-semibold mb-4">Active Equipment</h3>
          <div id="equipmentList" class="space-y-3">
            <p class="text-muted-foreground">Loading equipment...</p>
          </div>
        </div>

        <!-- Field List -->
        <div class="bg-secondary/10 rounded-lg p-4">
          <h3 class="text-lg font-semibold mb-4">Fields</h3>
          <div id="fieldList" class="space-y-3">
            <p class="text-muted-foreground">Loading fields...</p>
          </div>
        </div>

        <!-- Map Controls -->
        <div class="bg-secondary/10 rounded-lg p-4">
          <h3 class="text-lg font-semibold mb-4">Map Controls</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium mb-1">Map Layer</label>
              <select id="mapLayer" class="w-full rounded-lg border border-border bg-transparent px-4 py-2">
                <option value="streets-v11">Streets</option>
                <option value="satellite-streets-v11">Satellite Streets</option>
                <option value="outdoors-v11">Outdoors</option>
              </select>
            </div>
            <div>
              <label class="flex items-center space-x-2">
                <input type="checkbox" id="showBoundaries" checked>
                <span>Show Field Boundaries</span>
              </label>
            </div>
            <div>
              <label class="flex items-center space-x-2">
                <input type="checkbox" id="showEquipment" checked>
                <span>Show Equipment</span>
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Field Modal -->
    <div id="fieldModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-background rounded-lg p-6 max-w-lg w-full mx-4 shadow-lg">
        <h2 class="text-2xl font-bold mb-4">Add New Field</h2>
        <form id="fieldForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Field Name</label>
            <input type="text" name="name" required class="w-full rounded-lg border border-border bg-transparent px-4 py-2">
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Area (acres)</label>
            <input type="number" name="area" required class="w-full rounded-lg border border-border bg-transparent px-4 py-2">
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Crop Type</label>
            <select name="cropType" required class="w-full rounded-lg border border-border bg-transparent px-4 py-2">
              <option value="wheat">Wheat</option>
              <option value="corn">Corn</option>
              <option value="soybean">Soybean</option>
              <option value="rice">Rice</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">Field Boundaries (GeoJSON)</label>
            <textarea name="boundaries" rows="4" class="w-full rounded-lg border border-border bg-transparent px-4 py-2" placeholder="Paste GeoJSON for field boundaries or draw on map"></textarea>
          </div>
          
          <div class="flex justify-end space-x-4 mt-6">
            <button type="button" onclick="hideFieldForm()" class="px-4 py-2 rounded-lg border border-border hover:bg-secondary">
              Cancel
            </button>
            <button type="submit" class="px-6 py-2 rounded-lg bg-primary text-primary-foreground shadow hover:bg-opacity-90">
              Add Field
            </button>
          </div>
        </form>
      </div>
    </div>
  
  </main>

<!-- Footer -->
<footer class="bg-dark-200 border-t border-dark-300 pt-12 pb-8">
  <div class="container mx-auto px-4">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
      <!-- Company Info -->
      <div>
        <img src="assets/images/logo.png" alt="FarmPower" class="h-8 mb-4">
        <p class="text-gray-400 mb-4">Empowering farmers with modern tools and technology for better farming.</p>
        <div class="flex space-x-4">
          <a href="#" class="text-gray-400 hover:text-white transition-colors">
            <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
              <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
          </a>
          <a href="#" class="text-gray-400 hover:text-white transition-colors">
            <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
              <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
            </svg>
          </a>
          <a href="#" class="text-gray-400 hover:text-white transition-colors">
            <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm4.995 16.979H7.005v-9.95h9.99v9.95zM9 7.004a2.004 2.004 0 11-4.008 0A2.004 2.004 0 019 7.004zm11.428 9.975h-9.99V9.003h9.99v7.976z"/>
            </svg>
          </a>
        </div>
      </div>

      <!-- Quick Links -->
      <div>
        <h3 class="text-lg font-semibold mb-4">Quick Links</h3>
        <ul class="space-y-2">
            <li><a href="index.html" class="text-gray-400 hover:text-white transition-colors">Home</a></li>
            <li><a href="marketplace.html" class="text-gray-400 hover:text-white transition-colors">Marketplace</a></li>
            <li><a href="collections.html" class="text-gray-400 hover:text-white transition-colors">Tractors</a></li>
            <li><a href="parts-marketplace.html" class="text-gray-400 hover:text-white transition-colors">Parts</a></li>
            <li><a href="crop-calculator.html" class="text-gray-400 hover:text-white transition-colors">Crop Calculator</a></li>
        </ul>
      </div>

      <!-- Support -->
      <div>
        <h3 class="text-lg font-semibold mb-4">Support</h3>
        <ul class="space-y-2">
            <li><a href="faq.html" class="text-gray-400 hover:text-white transition-colors">FAQ</a></li>
            <li><a href="collections.html" class="text-gray-400 hover:text-white transition-colors">Contact Us</a></li>
            <li><a href="shipping.html" class="text-gray-400 hover:text-white transition-colors">Shipping Info</a></li>
            <li><a href="returns.html" class="text-gray-400 hover:text-white transition-colors">Returns</a></li>
            <li><a href="terms.html" class="text-gray-400 hover:text-white transition-colors">Terms & Conditions</a></li>
        </ul>
      </div>

      <!-- Newsletter -->
      <div>
        <h3 class="text-lg font-semibold mb-4">Newsletter</h3>
        <p class="text-gray-400 mb-4">Subscribe to our newsletter for updates and exclusive offers.</p>
        <form class="space-y-2">
          <input type="email" placeholder="Your email" class="w-full px-4 py-2 bg-dark-300 border border-dark-400 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500">
          <button type="submit" class="w-full px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors">
            Subscribe
          </button>
        </form>
      </div>
    </div>

    <!-- Bottom Bar -->
    <div class="pt-8 border-t border-dark-300">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <p class="text-gray-400 text-sm">&copy; 2024 FarmPower. All rights reserved.</p>
        <div class="flex space-x-4 mt-4 md:mt-0">
            <a href="privacy.html" class="text-gray-400 hover:text-white text-sm transition-colors">Privacy Policy</a>
            <a href="terms.html" class="text-gray-400 hover:text-white text-sm transition-colors">Terms of Service</a>
            <a href="settings.html" class="text-gray-400 hover:text-white text-sm transition-colors">Sitemap</a>
        </div>
      </div>
    </div>
  </div>
</footer>

<script>
  // Initialize Mapbox
  document.addEventListener('DOMContentLoaded', () => {
    // Set your Mapbox access token
    mapboxgl.accessToken = 'YOUR_MAPBOX_ACCESS_TOKEN';
    
    // Initialize map
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/satellite-v9',
      center: [76.7794, 30.7333],
      zoom: 13
    });
    
    // Add navigation control
    map.addControl(new mapboxgl.NavigationControl());
    
    // Initialize the draw control
    const draw = new MapboxDraw({
      displayControlsDefault: false,
      controls: {
        polygon: true,
        trash: true
      },
      styles: [
        {
          'id': 'gl-draw-line',
          'type': 'line',
          'filter': ['all', ['==', '$type', 'LineString'], ['!=', 'mode', 'static']],
          'layout': {
            'line-cap': 'round',
            'line-join': 'round'
          },
          'paint': {
            'line-color': '#3bb2d0',
            'line-width': 2,
            'line-dasharray': [0.2, 2]
          }
        },
        {
          'id': 'gl-draw-polygon-fill',
          'type': 'fill',
          'filter': ['all', ['==', '$type', 'Polygon'], ['!=', 'mode', 'static']],
          'paint': {
            'fill-color': '#3bb2d0',
            'fill-outline-color': '#3bb2d0',
            'fill-opacity': 0.2
          }
        },
        {
          'id': 'gl-draw-polygon-stroke-active',
          'type': 'line',
          'filter': ['all', ['==', '$type', 'Polygon'], ['==', 'active', 'true']],
          'layout': {
            'line-cap': 'round',
            'line-join': 'round'
          },
          'paint': {
            'line-color': '#3bb2d0',
            'line-width': 2,
            'line-dasharray': [0.2, 2]
          }
        }
      ]
    });
    
    // Add draw control to the map
    map.addControl(draw);
    
    // Track equipment positions
    const equipmentPositions = {};
    
    // Add equipment to map
    function addEquipment(id, name, position) {
      // Create a marker for the equipment
      const el = document.createElement('div');
      el.className = 'equipment-marker';
      el.id = `equipment-${id}`;
      
      new mapboxgl.Marker(el)
        .setLngLat(position)
        .setPopup(new mapboxgl.Popup({ offset: 25 })
          .setHTML(`<h3>${name}</h3><p>Last updated: Just now</p>`))
        .addTo(map);
      
      equipmentPositions[id] = position;
    }
    
    // Update equipment position
    function updateEquipmentPosition(id, newPosition) {
      if (equipmentPositions[id]) {
        // In a real app, you would update the marker position here
        console.log(`Equipment ${id} moved to`, newPosition);
      } else {
        addEquipment(id, `Equipment ${id}`, newPosition);
      }
    }
    
    // Simulate equipment movement (for demo)
    function simulateEquipmentMovement() {
      Object.keys(equipmentPositions).forEach(id => {
        const currentPos = equipmentPositions[id];
        const newLng = currentPos[0] + (Math.random() * 0.001 - 0.0005);
        const newLat = currentPos[1] + (Math.random() * 0.001 - 0.0005);
        updateEquipmentPosition(id, [newLng, newLat]);
      });
    }
    
    // Set up draw controls
    document.getElementById('draw-polygon').addEventListener('click', () => {
      draw.changeMode('draw_polygon');
    });
    
    document.getElementById('delete-features').addEventListener('click', () => {
      draw.deleteAll();
      document.getElementById('field-stats').classList.add('hidden');
    });
    
    document.getElementById('calculate-area').addEventListener('click', () => {
      const data = draw.getAll();
      if (data.features.length > 0) {
        const area = turf.area(data);
        const areaInAcres = area * 0.000247105; // Convert to acres
        
        // Calculate perimeter
        let perimeter = 0;
        data.features.forEach(feature => {
          if (feature.geometry.type === 'Polygon') {
            perimeter += turf.length(feature, { units: 'miles' });
          }
        });
        
        // Display stats
        const statsContent = document.getElementById('stats-content');
        statsContent.innerHTML = `
          <p><strong>Area:</strong> ${areaInAcres.toFixed(2)} acres</p>
          <p><strong>Perimeter:</strong> ${perimeter.toFixed(2)} miles</p>
          <p><strong>Fields:</strong> ${data.features.length}</p>
        `;
        
        document.getElementById('field-stats').classList.remove('hidden');
      }
    });
    
    // Add sample equipment (for demo)
    map.on('load', () => {
      // Add initial equipment
      addEquipment('tractor1', 'John Deere 8R', [76.7794, 30.7333]);
      addEquipment('tractor2', 'New Holland T7', [76.784, 30.738]);
      
      // Simulate movement every 5 seconds
      setInterval(simulateEquipmentMovement, 5000);
      
      // Add draw events
      map.on('draw.create', updateArea);
      map.on('draw.delete', updateArea);
      map.on('draw.update', updateArea);
    });
    
    // Update area display
    function updateArea() {
      const data = draw.getAll();
      if (data.features.length > 0) {
        const area = turf.area(data);
        const areaInAcres = area * 0.000247105; // Convert to acres
        console.log(`Total area: ${areaInAcres.toFixed(2)} acres`);
      }
    }

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    L.marker([30.7333, 76.7794]).addTo(map)
      .bindPopup('A pretty CSS popup.<br> Easily customizable.')
      .openPopup();
  });

  // Load header and footer
  fetch('components/header.html')
    .then(response => response.text())
    .then(data => {
      document.getElementById('header').innerHTML = data;
      // Ensure cart.updateCartCount() is called after cart.js is loaded
      if (typeof cart !== 'undefined' && cart.updateCartCount) {
        cart.updateCartCount();
      }
    });

  fetch('components/footer.html')
    .then(response => response.text())
    .then(data => {
      document.getElementById('footer').innerHTML = data;
    });

  // Mapbox GL JS Access Token
  mapboxgl.accessToken = 'pk.eyJ1IjoiaGFyZGlrMjciLCJhIjoiY2x3dnM2a2Y5MDBrZjJrcWwyN3QyN3d5ZiJ9.lO18kS_B0-s02L_z1O1-4g'; // Replace with your actual Mapbox access token

  // Initialize the map
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11',
    center: [-74.5, 40],
    zoom: 9
  });

  // Dummy Data (replace with API calls later)
  let equipmentData = [
    { id: 1, name: 'Tractor A', lat: 40.7, lng: -74.5, status: 'active' },
    { id: 2, name: 'Combine B', lat: 40.6, lng: -74.6, status: 'idle' },
    { id: 3, name: 'Sprayer C', lat: 40.8, lng: -74.4, status: 'maintenance' },
  ];

  let fieldsData = [
    {
      id: 1,
      name: 'North Field',
      area: 120,
      cropType: 'wheat',
      boundaries: {
        type: 'FeatureCollection',
        features: [
          {
            type: 'Feature',
            properties: {},
            geometry: {
              type: 'Polygon',
              coordinates: [
                [
                  [-74.55, 40.72],
                  [-74.5, 40.75],
                  [-74.48, 40.70],
                  [-74.55, 40.72]
                ]
              ]
            }
          }
        ]
      }
    },
    {
      id: 2,
      name: 'South Field',
      area: 80,
      cropType: 'corn',
      boundaries: {
        type: 'FeatureCollection',
        features: [
          {
            type: 'Feature',
            properties: {},
            geometry: {
              type: 'Polygon',
              coordinates: [
                [
                  [-74.6, 40.58],
                  [-74.55, 40.62],
                  [-74.53, 40.57],
                  [-74.6, 40.58]
                ]
              ]
            }
          }
        ]
      }
    }
  ];

  // AI Chat Icon Button
  const aiChatButton = document.createElement('button');
  aiChatButton.id = 'ai-chat-button';
  aiChatButton.className = 'fixed bottom-6 right-6 bg-primary text-primary-foreground p-4 rounded-full shadow-lg hover:bg-primary/90 transition-all duration-200 z-50';
  aiChatButton.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
  `;
  document.body.appendChild(aiChatButton);

  // AI Chat Modal
  const aiChatModal = document.createElement('div');
  aiChatModal.id = 'ai-chat-modal';
  aiChatModal.className = 'fixed inset-0 bg-black/50 hidden z-50';
  aiChatModal.innerHTML = `
    <div class="absolute bottom-6 right-6 w-96 h-[500px] bg-secondary border border-border rounded-lg shadow-lg flex flex-col">
      <div class="flex items-center justify-between p-4 border-b border-border">
        <h3 class="text-lg font-medium">AI Farming Assistant</h3>
        <button id="close-chat" class="p-2 hover:bg-background rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div id="chat-window" class="flex-1 p-4 overflow-y-auto space-y-4">
        <div class="flex justify-start">
          <div class="bg-muted text-muted-foreground p-3 rounded-lg max-w-[70%]">
            Hello! I am your AI Farming Assistant. How can I help you today?
          </div>
        </div>
      </div>
      <div class="border-t border-border p-4 flex items-center space-x-4">
        <input type="text" id="user-input" class="flex-1 p-3 rounded-lg bg-background border border-border text-foreground focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Type your message...">
        <button id="send-button" class="inline-flex items-center justify-center rounded-lg bg-primary px-5 py-3 text-sm font-medium text-primary-foreground shadow transition-colors hover:bg-primary/90">
          Send
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(aiChatModal);

  // AI Chat Modal Logic
  const closeChatButton = document.getElementById('close-chat');
  const chatWindow = document.getElementById('chat-window');
  const userInput = document.getElementById('user-input');
  const sendButton = document.getElementById('send-button');

  // Toggle chat modal
  aiChatButton.addEventListener('click', () => {
    aiChatModal.classList.remove('hidden');
    aiChatButton.classList.add('hidden');
  });

  closeChatButton.addEventListener('click', () => {
    aiChatModal.classList.add('hidden');
    aiChatButton.classList.remove('hidden');
  });

  // Close modal when clicking outside
  aiChatModal.addEventListener('click', (e) => {
    if (e.target === aiChatModal) {
      aiChatModal.classList.add('hidden');
      aiChatButton.classList.remove('hidden');
    }
  });

  const appendMessage = (sender, message) => {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('flex', sender === 'user' ? 'justify-end' : 'justify-start');
    messageDiv.innerHTML = `
      <div class="${sender === 'user' ? 'bg-primary text-primary-foreground' : 'bg-muted text-muted-foreground'} p-3 rounded-lg max-w-[70%]">
        ${message}
      </div>
    `;
    chatWindow.appendChild(messageDiv);
    chatWindow.scrollTop = chatWindow.scrollHeight; // Scroll to bottom
  };

  const sendMessage = async () => {
    const query = userInput.value.trim();
    if (query) {
      appendMessage('user', query);
      userInput.value = ''; // Clear input

      try {
        const response = await fetch('http://localhost:3000/api/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
          body: JSON.stringify({ query: query }),
      });

        const data = await response.json();
      if (response.ok) {
          appendMessage('ai', data.response);
      } else {
          appendMessage('ai', `Error: ${data.error || 'Something went wrong.'}`);
        }
      } catch (error) {
        console.error('Error sending message to AI:', error);
        appendMessage('ai', 'Error: Could not connect to the AI service.');
      }
    }
  };

  sendButton.addEventListener('click', sendMessage);

  userInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  // Mapbox Draw for drawing field boundaries
  const MapboxDraw = new MapboxDraw({
    displayControlsDefault: false,
    controls: {
        polygon: true,
        trash: true
    }
  });
  
  // Functions to display data on map
  map.on('load', () => {
    // Add MapboxDraw control
    map.addControl(MapboxDraw, 'top-left');

    // Add equipment sources and layers
    map.addSource('equipment-points', {
      type: 'geojson',
      data: {
        type: 'FeatureCollection',
        features: equipmentData.map(eq => ({
          type: 'Feature',
          geometry: {
            type: 'Point',
            coordinates: [eq.lng, eq.lat]
          },
          properties: eq
        }))
      }
    });

    map.addLayer({
      id: 'equipment-circles',
      type: 'circle',
      source: 'equipment-points',
      paint: {
        'circle-radius': 8,
        'circle-color': [
          'match',
          ['get', 'status'],
          'active', '#4CAF50',
          'idle', '#FFC107',
          'maintenance', '#F44336',
          '#CCCCCC' // default color
        ],
        'circle-stroke-color': '#FFFFFF',
        'circle-stroke-width': 2
      }
    });

    // Add field boundaries
    map.addSource('field-boundaries', {
      type: 'geojson',
      data: {
        type: 'FeatureCollection',
        features: fieldsData.flatMap(field => field.boundaries.features)
      }
    });

    map.addLayer({
      id: 'field-fill',
      type: 'fill',
      source: 'field-boundaries',
      paint: {
        'fill-color': '#4CAF50',
        'fill-opacity': 0.3
      }
    });

    map.addLayer({
      id: 'field-border',
      type: 'line',
      source: 'field-boundaries',
      paint: {
        'line-color': '#4CAF50',
        'line-width': 2
      }
    });

    // Populate equipment and field lists
    renderEquipmentList();
    renderFieldList();
  });

  // Map layer control
  document.getElementById('mapLayer').addEventListener('change', (e) => {
    map.setStyle('mapbox://styles/mapbox/' + e.target.value);
  });

  // Show/hide boundaries control
  document.getElementById('showBoundaries').addEventListener('change', (e) => {
    const visibility = e.target.checked ? 'visible' : 'none';
    map.setLayoutProperty('field-fill', 'visibility', visibility);
    map.setLayoutProperty('field-border', 'visibility', visibility);
  });

  // Show/hide equipment control
  document.getElementById('showEquipment').addEventListener('change', (e) => {
    const visibility = e.target.checked ? 'visible' : 'none';
    map.setLayoutProperty('equipment-circles', 'visibility', visibility);
  });

  // Render functions for side lists
  function renderEquipmentList() {
    const container = document.getElementById('equipmentList');
    container.innerHTML = '';
    if (equipmentData.length === 0) {
      container.innerHTML = '<p class="text-muted-foreground">No active equipment.</p>';
      return;
    }
    equipmentData.forEach(eq => {
      const div = document.createElement('div');
      div.className = 'bg-background rounded-lg p-3 flex items-center justify-between';
      div.innerHTML = `
        <div>
          <p class="font-medium">${eq.name}</p>
          <p class="text-sm text-muted-foreground">Status: ${eq.status}</p>
        </div>
        <button onclick="zoomToEquipment(${eq.lat}, ${eq.lng})" class="text-primary hover:text-primary-foreground">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </button>
      `;
      container.appendChild(div);
    });
  }

  function renderFieldList() {
    const container = document.getElementById('fieldList');
    container.innerHTML = '';
    if (fieldsData.length === 0) {
      container.innerHTML = '<p class="text-muted-foreground">No fields defined.</p>';
      return;
    }
    fieldsData.forEach(field => {
      const div = document.createElement('div');
      div.className = 'bg-background rounded-lg p-3 flex items-center justify-between';
      div.innerHTML = `
        <div>
          <p class="font-medium">${field.name}</p>
          <p class="text-sm text-muted-foreground">Area: ${field.area} acres, Crop: ${field.cropType}</p>
        </div>
        <button onclick="zoomToField(${field.id})" class="text-primary hover:text-primary-foreground">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </button>
      `;
      container.appendChild(div);
    });
  }

  // Zoom functions
  function zoomToEquipment(lat, lng) {
    map.flyTo({ center: [lng, lat], zoom: 12 });
  }

  function zoomToField(fieldId) {
    const field = fieldsData.find(f => f.id === fieldId);
    if (field && field.boundaries.features.length > 0) {
      const bounds = new mapboxgl.LngLatBounds();
      field.boundaries.features.forEach(feature => {
        if (feature.geometry.type === 'Polygon') {
          feature.geometry.coordinates[0].forEach(coord => {
            bounds.extend(coord);
          });
        } else if (feature.geometry.type === 'MultiPolygon') {
            feature.geometry.coordinates.forEach(polygonCoords => {
                polygonCoords[0].forEach(coord => {
                    bounds.extend(coord);
                });
            });
        }
      });
      map.fitBounds(bounds, { padding: 50 });
    }
  }

  // Modal controls
  window.showFieldForm = function() {
    document.getElementById('fieldModal').classList.remove('hidden');
    if (MapboxDraw) MapboxDraw.deleteAll(); // Clear any drawn features when opening the form
    map.on('draw.create', updateDrawData);
    map.on('draw.delete', updateDrawData);
    map.on('draw.update', updateDrawData);
  };

  window.hideFieldForm = function() {
    document.getElementById('fieldModal').classList.add('hidden');
    map.off('draw.create', updateDrawData);
    map.off('draw.delete', updateDrawData);
    map.off('draw.update', updateDrawData);
  };

  function updateDrawData() {
    const data = MapboxDraw.getAll();
    document.querySelector('textarea[name="boundaries"]').value = JSON.stringify(data);
  }

  // Handle add field form submission
  document.getElementById('fieldForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const newField = {
      id: fieldsData.length + 1,
      name: formData.get('name'),
      area: parseFloat(formData.get('area')),
      cropType: formData.get('cropType'),
      boundaries: JSON.parse(formData.get('boundaries') || '{"type":"FeatureCollection","features":[]}')
    };
    fieldsData.push(newField);
    renderFieldList();
    hideFieldForm();

    // Update map source for new field
    if (map.getSource('field-boundaries')) {
      const currentGeoJSON = map.getSource('field-boundaries')._data;
      currentGeoJSON.features.push(...newField.boundaries.features);
      map.getSource('field-boundaries').setData(currentGeoJSON);
    }

    alert('Field added successfully!');
  });

</script> 
  <script src="assets/js/floatingChatbot.js"></script>
  </main>
  
  <!-- Footer will be loaded here -->
  <div id="footer"></div>
</body>
</html>